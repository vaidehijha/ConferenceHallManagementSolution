@page "/hall-configuration"
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@using ConferenceHallManagement.web.ViewModels
@using ConferenceHallManagement.web.Services
@inject HallConfigurationService Service
@inject IJSRuntime JS

<div class="container mt-4">
    <div class="card shadow border-0">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Hall Configuration</h5>
        </div>
        <div class="card-body">

            <EditForm Model="@hallVM" OnValidSubmit="HandleSave">
                <DataAnnotationsValidator />

                <h6 class="text-secondary border-bottom pb-2">Hall Details</h6>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Hall Name</label>
                        <InputText @bind-Value="hallVM.HallName" class="form-control" placeholder="Ex: Grand Hall" />
                        <ValidationMessage For="@(() => hallVM.HallName)" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Location</label>
                        <InputText @bind-Value="hallVM.Location" class="form-control" placeholder="Ex: 1st Floor" />
                        <ValidationMessage For="@(() => hallVM.Location)" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Capacity</label>
                        <InputNumber @bind-Value="hallVM.Capacity" class="form-control" />
                        <ValidationMessage For="@(() => hallVM.Capacity)" />
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mt-4 mb-2">
                    <h6 class="text-primary mb-0">Session Configuration</h6>
                    <button type="button" class="btn btn-outline-primary btn-sm" @onclick="AddSession">
                        <i class="bi bi-plus-lg"></i> + Add Session
                    </button>
                </div>

                <table class="table table-bordered align-middle table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Session Name</th>
                            <th>Start Time</th>
                            <th>End Time</th>
                            <th>Price</th>
                            <th style="width: 50px;" class="text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (hallVM.Sessions.Count == 0)
                        {
                            <tr>
                                <td colspan="5" class="text-center text-muted py-3">
                                    No sessions added. Click "+ Add Session" to begin.
                                </td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var session in hallVM.Sessions)
                            {
                                <tr>
                                    <td>
                                        <InputText @bind-Value="session.SessionName" class="form-control form-control-sm" placeholder="Ex: Morning" />
                                        <ValidationMessage For="@(() => session.SessionName)" />
                                    </td>
                                    <td>
                                        <InputDate Type="InputDateType.Time" @bind-Value="session.StartTime" class="form-control form-control-sm" />
                                    </td>
                                    <td>
                                        <InputDate Type="InputDateType.Time" @bind-Value="session.EndTime" class="form-control form-control-sm" />
                                    </td>
                                    <td>
                                        <InputNumber @bind-Value="session.Price" class="form-control form-control-sm" />
                                    </td>
                                    <td class="text-center">
                                        <button type="button" class="btn btn-danger btn-sm" @onclick="() => RemoveSession(session)" title="Remove">
                                            X
                                        </button>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                    <button type="submit" class="btn btn-success px-4">Save Configuration</button>
                </div>

            </EditForm>
        </div>
    </div>
</div>

@code {
    private HallConfigurationVM hallVM = new HallConfigurationVM();

    protected override void OnInitialized()
    {
        // Start with one empty row so the user sees what to do immediately
        AddSession();
    }

    private void AddSession()
    {
        hallVM.Sessions.Add(new SessionConfigVM
        {
            SessionName = "Morning Slot",
            StartTime = DateTime.Today.AddHours(9),  // Default 9 AM
            EndTime = DateTime.Today.AddHours(12)     // Default 12 PM
        });
    }

    private void RemoveSession(SessionConfigVM item)
    {
        hallVM.Sessions.Remove(item);
    }

    private async Task HandleSave()
    {
        // Simple validation to ensure at least one session exists
        if (hallVM.Sessions.Count == 0)
        {
            await JS.InvokeVoidAsync("alert", "Please add at least one session slot.");
            return;
        }

        var success = await Service.SaveHallConfiguration(hallVM);

        if (success)
        {
            await JS.InvokeVoidAsync("alert", "Hall Configured Successfully!");
            // Reset the form
            hallVM = new HallConfigurationVM();
            AddSession();
        }
        else
        {
            await JS.InvokeVoidAsync("alert", "Error: Failed to save configuration. Please check the logs.");
        }
    }
}